{% extends "layouts/authenticated.html" %}
{% block title %} Withdraw {% endblock %}
{% block content %}
    <div id="app">
        <div class="dashboard-container">
            <!-- Logo -->
            {% include "partials/header.html" %}

            <!-- Flash messages -->
            {% include 'partials/flash.html' %}

            <!-- Back to Dashboard Link -->
            <a href="{{ url_for("user.dashboard") }}" class="wallet-info-bar" style="text-decoration: none; cursor: pointer;">
                <span class="wallet-address-short">‚Üê Back to Dashboard</span>
                <span class="wallet-address-short">{{ wallet_data.wallet_address[:6] }}...{{ wallet_data.wallet_address[-4:] }}</span>
            </a>

            <!-- Currency Balance Cards -->
            <div class="balance-cards">
                <div class="balance-card">
                    <div class="balance-icon">
                        <img src="{{ url_for('static', filename='images/solana.svg') }}" alt="SOL" />
                    </div>
                    <div class="balance-amount" id="sol-balance">{{ wallet_data.balances.sol.amount }}</div>
                </div>
                <a href="{{ url_for('solana_transaction.new', type=kind, asset='eurc') }}"
                   class="balance-card balance-card-clickable {% if asset|lower == 'eurc' %}balance-card-selected{% endif %}"
                   style="text-decoration: none; color: inherit;">
                    <div class="balance-icon">
                        <img src="{{ url_for('static', filename='images/eurc_token.svg') }}" alt="EURC" />
                    </div>
                    <div class="balance-amount" id="eurc-balance">{{ wallet_data.balances.eurc.amount }}</div>
                </a>
                <a href="{{ url_for('solana_transaction.new', type=kind, asset='usdc') }}"
                   class="balance-card balance-card-clickable {% if asset|lower == 'usdc' %}balance-card-selected{% endif %}"
                   style="text-decoration: none; color: inherit;">
                    <div class="balance-icon">
                        <img src="{{ url_for('static', filename='images/usdc_token.svg') }}" alt="USDC" />
                    </div>
                    <div class="balance-amount" id="usdc-balance">{{ wallet_data.balances.usdc.amount }}</div>
                </a>
            </div>

            <!-- Instructions -->
            <div class="welcome-card">
                <span id="instructions">Please select the asset you want to transact in</span>
            </div>

            <div id="transaction_form">
                <form method="POST" action="{{ url_for('solana_transaction.new', type=kind, asset=asset) }}"
                      id="register-form">
                    {{ form.csrf_token }}

                    <!-- Amount Input -->
                    <div class="transaction-amount-input">
                        {{ form.amount(class="amount-input-field", id="amountInput", placeholder="0.00", required=True, autocomplete="off") }}
                        <span class="amount-currency">{{ asset | upper }}</span>
                    </div>

                    <!-- Transaction Details Card -->
                    <div class="transaction-details-card">
                        <div class="transaction-detail-row">
                            <span class="detail-label">Transaction Fee</span>
                            <span class="detail-value" id="fee">0.00</span>
                        </div>
                        <div class="transaction-detail-row">
                            <span class="detail-label">Amount you will send</span>
                            <span class="detail-value" id="total">0.00</span>
                        </div>
                        <div id="error" class="error-message"></div>
                    </div>

                    <!-- Profile Fields -->
                    <div class="profile-fields">
                        {{ form.profile_id(value=user_data.id) }}

                        {% for profile_field in form.profile %}
                            {{ profile_field.hidden_tag() }}
                            <div class="form-group">
                                <label for="profile_field_name" class="form-label">{{ profile_field.label }}</label>
                                {{ profile_field(class="form-input", id="profile_field_name") }}
                                {% if profile_field.description %}
                                    <div class="field-description">{{ profile_field.description }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Terms Notice -->
                    <div class="terms-notice">
                        <p>
                            By clicking "Continue" you accept MYKOBO
                            <a href="https://terms.mykobo.co/virtual-currency-transactions" target="_blank">terms of use</a>
                            with regard to virtual currency transactions.
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="dashboard-action-btn full-width" id="submit-btn">
                        Continue
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block additional_javascript %}
    <script>
        const minAmount = {{ min_amount }};
        const maxAmount = {{ max_amount }};
        const feeEndPoint = "{{ fee_endpoint }}";
        const transactionKind = "{{ kind }}";
        const clientDomain = "{{ client_domain }}";

        // Hide transaction form if no asset parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const assetParam = urlParams.get('asset');
        const instructionsElement = document.getElementById('instructions');

        if (!assetParam) {
            const transactionForm = document.getElementById('transaction_form');
            if (transactionForm) {
                transactionForm.style.display = 'none';
            }
        } else {
            if (instructionsElement) {
                instructionsElement.textContent = 'Enter amount to withdraw';
            }
        }

        // Disable button and change cursor on form submit
        const form = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-btn');

        if (form && submitBtn) {
            form.addEventListener('submit', function(e) {
                // Disable the button
                submitBtn.disabled = true;
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.style.opacity = '0.6';
                submitBtn.textContent = 'Processing...';
            });
        }
    </script>
    <script src="{{ url_for('static', filename='aux/transaction.js') }}"></script>
    <script src="{{ url_for('static', filename='aux/common.js') }}"></script>
{% endblock %}
