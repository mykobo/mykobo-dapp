{% extends "layouts/authenticated.html" %}
{% block title %} Sign Withdrawal {% endblock title %}
{% block content %}

    <!-- Wallet Info Button -->
    <a href="{{ url_for("user.dashboard") }}" class="wallet-info-button mb-2">
        <span class="wallet-address">Welcome back {{ user_data.first_name }} {{ user_data.last_name }}! </span>
        <span id="wallet-balance"
              class="wallet-balance">{{ wallet_data.wallet_address[:9] }}...{{ wallet_data.wallet_address[-4:] }}</span>
    </a>

    <!-- Currency Balance Buttons -->
    {% include "partials/currency_buttons.html" %}

    <div class="card card-body rounded-3 mb-4 mt-4">
        <div class="row">
            <span class="display-5">You are withdrawing</span><br/>
            <span class="text-lg-start display-3 pt-1 p-3">{{ transaction_data.value | round(2) }} {{ transaction_data.outgoing_currency }}</span>
        </div>
        <div class="row">
            <div class="display-5">Fee</div>
            <div class="pt-1 p-3">{{ transaction_data.fee | round(2) }} {{ transaction_data.outgoing_currency }}</div>
        </div>
        <div class="row">
            <div class="display-5">Reference</div>
            <div class="pt-1 p-3">{{ reference }}</div>
            <br/>
        </div>
    </div>

    <div class="card card-body rounded-3 mb-4">
        <div class="alert alert-info p-2" role="alert">
            <p><strong>Sign with your Solana wallet</strong></p>
            <p>Please approve the transaction in your wallet to complete the withdrawal. The transaction will transfer {{ transaction_data.value | round(2) }} {{ transaction_data.outgoing_currency }} from your wallet.</p>
        </div>

        <div id="transaction-status" class="mb-3">
            <div class="spinner-border text-primary" role="status" style="display: none;" id="loading-spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div id="status-message"></div>
        </div>

        <button type="button" class="action-button primary-button mb-3" id="sign-transaction-btn">
            Sign Transaction with Wallet
        </button>

        <button type="button" class="action-button secondary-button" id="cancel-btn" onclick="window.location.href='{{ url_for('user.dashboard') }}'">
            Cancel
        </button>
    </div>

{% endblock %}

{% block additional_javascript %}
<script>
    const unsignedTransaction = "{{ unsigned_transaction }}";
    const reference = "{{ reference }}";
    const destination = "{{ destination }}";
    const amount = {{ transaction_data.value }};
    const currency = "{{ transaction_data.outgoing_currency }}";

    document.getElementById('sign-transaction-btn').addEventListener('click', async function() {
        const statusMessage = document.getElementById('status-message');
        const spinner = document.getElementById('loading-spinner');
        const signButton = document.getElementById('sign-transaction-btn');

        try {
            // Check if Solana wallet is available
            if (!window.solana || !window.solana.isPhantom) {
                statusMessage.innerHTML = '<div class="alert alert-danger">Please install Phantom wallet or another Solana wallet extension.</div>';
                return;
            }

            // Show loading state
            spinner.style.display = 'inline-block';
            statusMessage.innerHTML = '<div class="alert alert-info">Requesting wallet signature...</div>';
            signButton.disabled = true;

            // Connect to wallet
            const resp = await window.solana.connect();
            console.log('Connected to wallet:', resp.publicKey.toString());

            // Decode the base64 transaction
            const transactionBuffer = Uint8Array.from(atob(unsignedTransaction), c => c.charCodeAt(0));

            // Create transaction from buffer
            const transaction = window.solanaWeb3.Transaction.from(transactionBuffer);

            // Sign and send transaction
            statusMessage.innerHTML = '<div class="alert alert-info">Please approve the transaction in your wallet...</div>';

            const signedTransaction = await window.solana.signAndSendTransaction(transaction);

            console.log('Transaction signature:', signedTransaction.signature);

            // Wait for transaction to be confirmed on Solana before verifying with backend
            statusMessage.innerHTML = '<div class="alert alert-info">Waiting for blockchain confirmation...</div>';

            // Wait 5 seconds to allow transaction to propagate to RPC nodes
            // Solana finalization takes ~12-14 seconds, but RPC availability can vary
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Send signature to backend to confirm transaction (with retry logic)
            statusMessage.innerHTML = '<div class="alert alert-info">Confirming transaction with server...</div>';

            // Get auth token from cookie
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            const authToken = getCookie('auth_token');

            // Retry confirmation up to 3 times with increasing delays
            let confirmResponse = null;
            let confirmData = null;
            let lastError = null;

            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    confirmResponse = await fetch("{{ url_for('transaction.confirm_withdraw_transaction', reference=reference) }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + authToken
                        },
                        body: JSON.stringify({
                            signature: signedTransaction.signature
                        })
                    });

                    confirmData = await confirmResponse.json();

                    // If successful, break out of retry loop
                    if (confirmResponse.ok) {
                        break;
                    }

                    // If transaction not found (404), wait and retry
                    if (confirmResponse.status === 404 && attempt < 3) {
                        console.log(`Attempt ${attempt}: Transaction not yet confirmed on-chain, retrying...`);
                        statusMessage.innerHTML = `<div class="alert alert-info">Waiting for transaction confirmation (attempt ${attempt}/3)...</div>`;
                        await new Promise(resolve => setTimeout(resolve, 4000 * attempt)); // Exponential backoff: 4s, 8s
                        continue;
                    }

                    // For other errors, save and break
                    lastError = confirmData;
                    break;

                } catch (fetchError) {
                    console.error(`Attempt ${attempt} failed:`, fetchError);
                    lastError = { message: fetchError.message };
                    if (attempt < 3) {
                        await new Promise(resolve => setTimeout(resolve, 4000 * attempt)); // 4s, 8s
                    }
                }
            }

            if (confirmResponse && confirmResponse.ok) {
                // Show success message
                spinner.style.display = 'none';
                statusMessage.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Transaction confirmed successfully!</strong><br/>
                        Signature: ${signedTransaction.signature.substring(0, 10)}...${signedTransaction.signature.substring(signedTransaction.signature.length - 10)}<br/>
                        Redirecting to transaction details...
                    </div>
                `;

                // Redirect to transaction info page after a delay
                setTimeout(() => {
                    window.location.href = "{{ url_for('transaction.info', reference=reference) }}";
                }, 3000);
            } else {
                // Show error but transaction was still submitted to blockchain
                spinner.style.display = 'none';
                const errorMsg = lastError ? (lastError.message || 'Unknown error') : 'Failed to confirm after multiple attempts';
                statusMessage.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Transaction submitted to blockchain but confirmation failed</strong><br/>
                        Signature: ${signedTransaction.signature.substring(0, 10)}...${signedTransaction.signature.substring(signedTransaction.signature.length - 10)}<br/>
                        Error: ${errorMsg}<br/>
                        Please contact support with this signature.
                    </div>
                `;
                signButton.disabled = false;
            }
        } catch (error) {
            spinner.style.display = 'none';
            signButton.disabled = false;

            let errorMessage = 'An error occurred while signing the transaction.';

            if (error.message) {
                if (error.message.includes('User rejected')) {
                    errorMessage = 'Transaction was cancelled.';
                } else {
                    errorMessage = error.message;
                }
            }

            console.error('Transaction error:', error);
            statusMessage.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${errorMessage}</div>`;
        }
    });
</script>

<!-- Include Solana Web3.js -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
{% endblock %}
